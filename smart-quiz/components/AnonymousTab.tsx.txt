
import React, { useState, useRef, useEffect } from 'react';
import { Ghost, MessageSquare, Share2, Camera, Film, Send, X, Loader2, Plus, Trash2, ThumbsUp, Eye, Edit3, Mic, Square, Volume2, User as UserIcon, Shield } from 'lucide-react';
import { Post, Comment, UserProfile } from '../types';
import { db, auth } from '../services/firebase';
import { collection, query, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, updateDoc, arrayUnion, where, limit, increment, arrayRemove } from 'firebase/firestore';

interface AnonymousTabProps {
  user?: UserProfile;
}

const AnonymousTab: React.FC<AnonymousTabProps> = ({ user }) => {
  const [posts, setPosts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [feedType, setFeedType] = useState<'all' | 'my'>('all');
  
  const [newPostContent, setNewPostContent] = useState('');
  const [isPublishing, setIsPublishing] = useState(false);
  const [isProcessingMedia, setIsProcessingMedia] = useState(false);
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const [selectedVideo, setSelectedVideo] = useState<string | null>(null);
  const [recordedAudio, setRecordedAudio] = useState<string | null>(null);
  const [showFullComposer, setShowFullComposer] = useState(false);
  const [editingPostId, setEditingPostId] = useState<string | null>(null);

  // Audio Recording States
  const [isRecording, setIsRecording] = useState(false);
  const [recordingTime, setRecordingTime] = useState(0);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const timerRef = useRef<any>(null);
  
  const [activeCommentPost, setActiveCommentPost] = useState<any | null>(null);
  const [commentText, setCommentText] = useState('');
  const [isCommenting, setIsCommenting] = useState(false);

  const imageInputRef = useRef<HTMLInputElement>(null);
  const videoInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    const qPosts = query(
      collection(db, 'posts'), 
      where('isAnonymous', '==', true),
      limit(150)
    );

    const unsubPosts = onSnapshot(qPosts, (snap) => {
      const fetchedPosts = snap.docs.map(d => ({ 
        id: d.id, 
        ...d.data() 
      }));
      
      fetchedPosts.sort((a: any, b: any) => {
        const timeA = a.timestamp?.toMillis?.() || a.timestamp || 0;
        const timeB = b.timestamp?.toMillis?.() || b.timestamp || 0;
        return timeB - timeA;
      });

      setPosts(fetchedPosts);
      setLoading(false);
    }, (error) => {
      console.error("Anonymous Feed Error:", error);
      setLoading(false);
    });

    return () => unsubPosts();
  }, []);

  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorderRef.current = mediaRecorder;
      const chunks: Blob[] = [];
      mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => setRecordedAudio(reader.result as string);
        stream.getTracks().forEach(track => track.stop());
      };
      mediaRecorder.start();
      setIsRecording(true);
      setRecordingTime(0);
      timerRef.current = setInterval(() => setRecordingTime(prev => prev + 1), 1000);
    } catch (err) {
      alert("মাইক্রোফোন পারমিশন প্রয়োজন।");
    }
  };

  const stopRecording = () => {
    if (mediaRecorderRef.current && isRecording) {
      mediaRecorderRef.current.stop();
      setIsRecording(false);
      clearInterval(timerRef.current);
    }
  };

  const handleMediaUpload = (e: React.ChangeEvent<HTMLInputElement>, target: 'post-image' | 'post-video') => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        alert("২ এমবি-র নিচের ফাইল আপলোড করুন।");
        return;
      }
      setIsProcessingMedia(true);
      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64 = reader.result as string;
        if (target === 'post-image') setSelectedImage(base64);
        else if (target === 'post-video') setSelectedVideo(base64);
        setIsProcessingMedia(false);
        setShowFullComposer(true);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleCreatePost = async () => {
    if (!newPostContent.trim() && !selectedImage && !selectedVideo && !recordedAudio) return;
    setIsPublishing(true);
    try {
      const postData = {
        userName: "Anonymous User",
        userAvatar: "anonymous",
        uid: auth.currentUser?.uid,
        content: newPostContent.trim(),
        image: selectedImage,
        video: selectedVideo,
        audio: recordedAudio,
        isAnonymous: true,
        likes: 0,
        likedBy: [],
        comments: [],
        views: 0,
        viewedBy: [],
        timestamp: serverTimestamp(),
        time: "এইমাত্র"
      };

      if (editingPostId) {
        await updateDoc(doc(db, 'posts', editingPostId), postData);
      } else {
        await addDoc(collection(db, 'posts'), postData);
      }

      setNewPostContent('');
      setSelectedImage(null);
      setSelectedVideo(null);
      setRecordedAudio(null);
      setEditingPostId(null);
      setShowFullComposer(false);
    } catch (e) {
      alert("পোস্ট করতে সমস্যা হয়েছে।");
    } finally {
      setIsPublishing(false);
    }
  };

  const handleDeletePost = async (postId: string) => {
    if (window.confirm("আপনি কি নিশ্চিতভাবে এই পোস্টটি ডিলিট করতে চান?")) {
      await deleteDoc(doc(db, 'posts', postId));
    }
  };

  const handleShare = async (post: any) => {
    const shareUrl = window.location.origin + window.location.pathname;
    const shareData = {
      title: 'Smart Quiz অনুভব কর্নার',
      text: post.content ? post.content.substring(0, 100) : 'অনুভব কর্নার - Smart Quiz',
      url: shareUrl
    };
    
    const fallbackToClipboard = async () => {
      try {
        await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
        alert("লিঙ্ক কপি করা হয়েছে!");
      } catch (e) {
        alert("শেয়ার করা সম্ভব হয়নি।");
      }
    };

    try {
      if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
        await navigator.share(shareData);
      } else {
        await fallbackToClipboard();
      }
    } catch (err) {
      if ((err as Error).name === 'AbortError') return;
      await fallbackToClipboard();
    }
  };

  const handleDeleteComment = async (comment: any) => {
    if (!activeCommentPost) return;
    if (window.confirm("আপনি কি এই মতামতটি মুছে ফেলতে চান?")) {
      try {
        await updateDoc(doc(db, 'posts', activeCommentPost.id), {
          comments: arrayRemove(comment)
        });
        setActiveCommentPost({
          ...activeCommentPost,
          comments: activeCommentPost.comments.filter((c: any) => c.id !== comment.id)
        });
      } catch (e) {
        alert("মুছে ফেলা সম্ভব হয়নি।");
      }
    }
  };

  const filteredPosts = feedType === 'my' 
    ? posts.filter(p => p.uid === auth.currentUser?.uid)
    : posts;

  return (
    <div className="bg-[#f0f2f5] min-h-screen pb-32 font-['Hind_Siliguri']">
      
      {/* Dynamic Header */}
      <div className="bg-indigo-900 px-6 pt-12 pb-16 rounded-b-[48px] shadow-xl relative overflow-hidden">
        <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-16 -mt-16 blur-2xl"></div>
        <h2 className="text-3xl font-black text-white mb-2 flex items-center gap-3">
          <Ghost className="text-indigo-300" size={32} /> অনুভব কর্নার
        </h2>
        <p className="text-indigo-200 font-bold text-xs uppercase tracking-widest opacity-80">জীবন নিয়ে আপনার অভিজ্ঞতা শেয়ার করুন</p>
      </div>

      <div className="px-4 -mt-8 relative z-10">
        <div className="bg-white p-2 rounded-[24px] shadow-lg flex gap-2 mb-6">
          <button 
            onClick={() => setFeedType('all')} 
            className={`flex-1 py-3 rounded-[20px] font-black text-xs transition-all ${feedType === 'all' ? 'bg-indigo-700 text-white shadow-md' : 'bg-slate-50 text-slate-400'}`}
          >
            সব পোস্ট
          </button>
          <button 
            onClick={() => setFeedType('my')} 
            className={`flex-1 py-3 rounded-[20px] font-black text-xs transition-all ${feedType === 'my' ? 'bg-indigo-700 text-white shadow-md' : 'bg-slate-50 text-slate-400'}`}
          >
            আমার পোস্ট
          </button>
        </div>

        {/* Secret Composer */}
        <div className="bg-indigo-50 p-6 rounded-[36px] border border-indigo-100 shadow-sm mb-6 flex flex-col items-center text-center">
           <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-inner mb-4">
              <Ghost className="text-indigo-500" size={32} />
           </div>
           <p className="text-indigo-900 font-black text-sm mb-4 leading-tight">আপনার পরিচয় গোপন থাকবে।<br/>মনের না বলা কথাগুলো লিখে ফেলুন।</p>
           <button 
             onClick={() => { setShowFullComposer(true); setEditingPostId(null); }}
             className="w-full bg-white py-4 rounded-2xl font-black text-indigo-700 shadow-sm text-sm border border-indigo-100 active:scale-95 transition-all"
           >
             জীবন নিয়ে অভিজ্ঞতা শেয়ার করুন...
           </button>
        </div>

        {/* Post Feed */}
        <div className="space-y-4">
          {filteredPosts.map(post => (
            <div key={post.id} className="bg-white rounded-[32px] shadow-sm border border-indigo-50 overflow-hidden">
               <div className="p-5 flex justify-between items-center bg-indigo-50/30">
                  <div className="flex items-center gap-3">
                     <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-md">
                        <UserIcon size={20} />
                     </div>
                     <div>
                        <h4 className="font-black text-indigo-900 text-sm">বেনামী ইউজার</h4>
                        <p className="text-[10px] text-slate-400 font-bold uppercase">{post.time}</p>
                     </div>
                  </div>
                  {post.uid === auth.currentUser?.uid && (
                    <div className="flex gap-2">
                       <button onClick={() => { setEditingPostId(post.id); setNewPostContent(post.content); setSelectedImage(post.image || null); setRecordedAudio(post.audio || null); setShowFullComposer(true); }} className="p-2 bg-white text-indigo-500 rounded-xl"><Edit3 size={16}/></button>
                       <button onClick={() => handleDeletePost(post.id)} className="p-2 bg-white text-rose-500 rounded-xl"><Trash2 size={16}/></button>
                    </div>
                  )}
               </div>

               <div className="p-6">
                  <p className="text-slate-800 text-[15px] leading-relaxed whitespace-pre-wrap mb-4 font-medium">{post.content}</p>
                  
                  {post.audio && (
                    <div className="mb-4 bg-slate-50 p-4 rounded-2xl border flex items-center gap-3">
                       <div className="w-10 h-10 bg-indigo-500 text-white rounded-full flex items-center justify-center shadow-lg"><Volume2 size={20}/></div>
                       <audio src={post.audio} controls className="flex-grow h-10 custom-audio" />
                    </div>
                  )}

                  {post.image && (
                    <div className="rounded-[24px] overflow-hidden border mb-4">
                       <img src={post.image} className="w-full object-contain" alt="experience" />
                    </div>
                  )}

                  <div className="flex items-center justify-between pt-4 border-t border-slate-50">
                     <div className="flex items-center gap-4">
                        <button 
                          onClick={async () => {
                            const uid = auth.currentUser?.uid;
                            if (!uid) return;
                            const isLiked = post.likedBy?.includes(uid);
                            await updateDoc(doc(db, 'posts', post.id), {
                              likedBy: isLiked ? arrayRemove(uid) : arrayUnion(uid),
                              likes: increment(isLiked ? -1 : 1)
                            });
                          }}
                          className={`flex items-center gap-1.5 font-black text-xs transition-all ${post.likedBy?.includes(auth.currentUser?.uid) ? 'text-indigo-600' : 'text-slate-400'}`}
                        >
                           <ThumbsUp size={16} fill={post.likedBy?.includes(auth.currentUser?.uid) ? 'currentColor' : 'none'} /> {post.likes || 0}
                        </button>
                        <button onClick={() => setActiveCommentPost(post)} className="flex items-center gap-1.5 text-slate-400 font-black text-xs">
                           <MessageSquare size={16} /> {post.comments?.length || 0}
                        </button>
                     </div>
                     <button onClick={() => handleShare(post)} className="text-slate-300"><Share2 size={18}/></button>
                  </div>
               </div>
            </div>
          ))}
          {loading && <div className="py-20 text-center"><Loader2 className="animate-spin mx-auto text-indigo-600" /></div>}
          {!loading && filteredPosts.length === 0 && (
            <div className="py-20 text-center opacity-30">
               <Ghost size={48} className="mx-auto mb-4" />
               <p className="text-sm font-black uppercase tracking-widest">কোনো পোস্ট নেই</p>
            </div>
          )}
        </div>
      </div>

      {/* Composer Overlay */}
      {showFullComposer && (
        <div className="fixed inset-0 bg-white z-[1000] flex flex-col animate-in slide-in-from-bottom duration-300">
           <div className="p-5 border-b flex items-center justify-between bg-indigo-900 text-white">
              <button onClick={() => setShowFullComposer(false)} className="p-2"><X size={24}/></button>
              <h3 className="font-black text-lg flex items-center gap-2"><Ghost size={20}/> গোপন পোস্ট</h3>
              <button 
                onClick={handleCreatePost}
                disabled={isPublishing || isProcessingMedia || (!newPostContent.trim() && !recordedAudio && !selectedImage)}
                className="px-6 py-2 bg-white text-indigo-900 rounded-xl font-black text-xs disabled:opacity-50"
              >
                {isPublishing ? <Loader2 className="animate-spin" size={16}/> : 'পোস্ট'}
              </button>
           </div>
           
           <div className="p-6 flex-grow overflow-y-auto">
              <div className="bg-indigo-50 p-4 rounded-2xl mb-6 flex gap-3 items-center">
                 <Shield className="text-indigo-600" size={20} />
                 <p className="text-[11px] font-black text-indigo-900 uppercase">জীবন নিয়ে আপনার অভিজ্ঞতা শেয়ার করুন। পরিচয় গোপন থাকবে।</p>
              </div>

              <textarea 
                value={newPostContent}
                onChange={(e) => setNewPostContent(e.target.value)}
                placeholder="আপনার মনে কী আছে? আজ দিনটি কেমন কাটলো?"
                className="w-full text-xl outline-none resize-none min-h-[200px] font-medium placeholder:text-slate-300"
                autoFocus
              />

              {recordedAudio && (
                <div className="mt-4 bg-rose-50 p-5 rounded-[28px] flex items-center justify-between border border-rose-100 shadow-sm animate-in zoom-in-95">
                  <div className="flex items-center gap-4">
                    <Mic size={24} className="text-rose-500" />
                    <span className="text-sm font-black text-rose-700 uppercase">ভয়েস যুক্ত হয়েছে</span>
                  </div>
                  <button onClick={() => setRecordedAudio(null)} className="text-rose-500 p-2 bg-white rounded-full shadow-sm"><X size={16}/></button>
                </div>
              )}

              {selectedImage && (
                <div className="relative rounded-[32px] overflow-hidden mt-4 border-2 border-indigo-50 shadow-md">
                   <img src={selectedImage} className="w-full" alt="selected" />
                   <button onClick={() => setSelectedImage(null)} className="absolute top-4 right-4 p-2 bg-black/50 text-white rounded-full"><X size={16}/></button>
                </div>
              )}
           </div>

           <div className="p-6 border-t flex items-center justify-around bg-slate-50">
              {isRecording ? (
                <div className="flex-grow flex items-center justify-between bg-rose-600 text-white p-5 rounded-[28px] mx-4 animate-pulse shadow-xl shadow-rose-600/20">
                   <div className="flex items-center gap-4">
                      <Square size={24} fill="currentColor" onClick={stopRecording} className="cursor-pointer" />
                      <span className="font-black text-base uppercase">রেকর্ড হচ্ছে: {recordingTime}s</span>
                   </div>
                   <button onClick={stopRecording} className="font-black text-xs bg-white text-rose-600 px-4 py-2 rounded-full">সম্পন্ন</button>
                </div>
              ) : (
                <>
                   <button onClick={() => imageInputRef.current?.click()} className="flex flex-col items-center gap-1 group">
                      <div className="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-sm text-indigo-600 group-active:scale-90 transition-all border border-indigo-100"><Camera size={28}/></div>
                      <span className="text-[10px] font-black text-slate-400 uppercase">ছবি</span>
                   </button>
                   <button onClick={startRecording} className="flex flex-col items-center gap-1 group">
                      <div className="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-sm text-rose-500 group-active:scale-90 transition-all border border-rose-100"><Mic size={28}/></div>
                      <span className="text-[10px] font-black text-slate-400 uppercase">ভয়েস</span>
                   </button>
                   <button onClick={() => videoInputRef.current?.click()} className="flex flex-col items-center gap-1 group">
                      <div className="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-sm text-blue-500 group-active:scale-90 transition-all border border-blue-100"><Film size={28}/></div>
                      <span className="text-[10px] font-black text-slate-400 uppercase">ভিডিও</span>
                   </button>
                </>
              )}
              <input type="file" ref={imageInputRef} onChange={(e) => handleMediaUpload(e, 'post-image')} className="hidden" accept="image/*" />
              <input type="file" ref={videoInputRef} onChange={(e) => handleMediaUpload(e, 'post-video')} className="hidden" accept="video/*" />
           </div>
        </div>
      )}

      {/* Comment Bottom Sheet */}
      {activeCommentPost && (
        <div className="fixed inset-0 bg-black/60 z-[2000] flex items-end justify-center backdrop-blur-sm">
           <div className="bg-white w-full max-w-md rounded-t-[44px] p-8 animate-in slide-in-from-bottom duration-300 max-h-[80vh] flex flex-col shadow-2xl">
              <div className="flex justify-between items-center mb-6">
                 <h3 className="font-black text-indigo-900">গোপন মতামত</h3>
                 <button onClick={() => setActiveCommentPost(null)} className="p-3 bg-slate-50 rounded-full text-slate-400"><X size={20}/></button>
              </div>
              <div className="flex-grow overflow-y-auto space-y-6 mb-6 no-scrollbar">
                 {activeCommentPost.comments?.map((c: any) => (
                   <div key={c.id} className="flex gap-4 group">
                      <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 shadow-inner shrink-0">
                         <UserIcon size={16} />
                      </div>
                      <div className="flex-grow">
                         <div className="bg-slate-50 p-4 rounded-[20px] border border-slate-100 relative">
                            <div className="flex justify-between items-start">
                               <p className="text-[10px] text-slate-300 font-black uppercase mb-1">{c.time}</p>
                               {(c.uid === auth.currentUser?.uid || activeCommentPost.uid === auth.currentUser?.uid) && (
                                 <button onClick={() => handleDeleteComment(c)} className="text-slate-200 hover:text-rose-500 transition-colors">
                                   <Trash2 size={12}/>
                                 </button>
                               )}
                            </div>
                            <p className="text-xs text-slate-700 font-medium leading-relaxed">{c.text}</p>
                         </div>
                      </div>
                   </div>
                 ))}
                 {(!activeCommentPost.comments || activeCommentPost.comments.length === 0) && (
                   <div className="text-center py-10 opacity-30">
                      <MessageSquare className="mx-auto mb-2" size={32}/>
                      <p className="text-[10px] font-black uppercase tracking-widest">এখনো কোনো মতামত নেই</p>
                   </div>
                 )}
              </div>
              <div className="flex gap-2">
                 <input 
                   type="text" 
                   value={commentText} 
                   onChange={(e) => setCommentText(e.target.value)} 
                   placeholder="কিছু লিখুন..." 
                   className="flex-grow bg-slate-100 p-4 rounded-2xl outline-none font-bold text-sm"
                 />
                 <button 
                   onClick={async () => {
                     if (!commentText.trim()) return;
                     setIsCommenting(true);
                     const commentObj = { 
                       id: Math.random().toString(), 
                       text: commentText.trim(), 
                       time: "এইমাত্র", 
                       uid: auth.currentUser?.uid,
                       timestamp: Date.now()
                     };
                     await updateDoc(doc(db, 'posts', activeCommentPost.id), { 
                       comments: arrayUnion(commentObj) 
                     });
                     setCommentText('');
                     setIsCommenting(false);
                     setActiveCommentPost({
                       ...activeCommentPost,
                       comments: [...(activeCommentPost.comments || []), commentObj]
                     });
                   }}
                   className="w-14 h-14 bg-indigo-700 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-700/20"
                 >
                    {isCommenting ? <Loader2 className="animate-spin" size={20}/> : <Send size={24}/>}
                 </button>
              </div>
           </div>
        </div>
      )}
    </div>
  );
};

export default AnonymousTab;
